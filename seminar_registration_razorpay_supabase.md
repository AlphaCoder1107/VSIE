# Seminar Registration — Detailed Integration Guide

**Feature goal:** Add a simple event registration flow on the VSIE site (hosted on GitHub Pages) so students can register for weekly Friday seminars, pay a ₹10 entry fee via Razorpay, and — **only after successful payment** — have their registration stored in Supabase with a unique registration code (e.g. `VIC-SEM-2025-000123`). Admins will be able to view and export successful registrations.

This document is an end-to-end guide (SQL, server endpoints, client code, deployment, testing, security, admin flows, and best practices).

---

## Table of contents
1. Overview & architecture
2. Supabase schema & SQL (copy-paste)
3. Server endpoints — create-order & verify-payment (Node) (Vercel / Netlify)
4. Supabase Edge Functions alternative (example)
5. Client integration (GitHub Pages) — modal + JS flow
6. Environment variables and deployment instructions
7. Testing checklist & Razorpay test cards
8. Admin UI & access to registrations
9. Error handling, logs & audit
10. Security & compliance (Aadhaar / PII guidance)
11. Payment edge cases: refunds, failed payments, retries
12. Analytics, email receipts & export
13. Appendix — sample cURL & debugging tips

---

## 1. Overview & architecture

Flow summary:

1. Student clicks **Register now** on an event card. A small modal form opens and collects basic details (name, email, phone, college, year). The event is identified by `event_slug`.
2. Client calls server endpoint `POST /api/create-order` to create a Razorpay Order (amount = ₹10 = 1000 paise). Server returns `order.id` and `key_id`.
3. Client opens Razorpay Checkout (client-side) using the received `order_id` and `key_id`. Student completes payment.
4. On success, Razorpay returns `razorpay_payment_id`, `razorpay_order_id` and `razorpay_signature` to the client handler.
5. Client posts the payment details and student form data to `POST /api/verify-payment`.
6. Server verifies signature and the payment status by calling Razorpay API. If verified and `status === 'captured'`, server inserts a row into Supabase `seminar_registrations` table (using `service_role` key) and returns the `registration_code` to the client.
7. Client shows success message and registration code; Admins can download CSV or view registrations in Supabase.

Architecture components:
- Static site on GitHub Pages (front-end).  
- Serverless endpoints (Vercel / Netlify / Supabase Edge Functions) hold Razorpay secret and Supabase service role key. These endpoints are responsible for order creation and payment verification + DB insert. Keys never live in client JS.
- Supabase (Postgres + Storage if needed) stores registrations. Use DB trigger to generate registration code.

---

## 2. Supabase schema & SQL (copy-paste)

Open Supabase Console → SQL Editor → run the block below.

```sql
-- 1. sequence to generate registration numbers
create sequence if not exists seminar_sequence start 1;

-- 2. function to generate code like: VIC-SEM-2025-000123
create or replace function public.generate_seminar_code()
returns text language sql as $$
  select 'VIC-SEM-' || to_char(current_date,'YYYY') || '-' || lpad(nextval('seminar_sequence')::text,6,'0');
$$;

-- 3. table: seminar_registrations
create table if not exists public.seminar_registrations (
  id bigint generated by default as identity primary key,
  registration_code text unique,
  event_slug text not null,
  student_name text not null,
  student_email text not null,
  student_phone text,
  college text,
  year text,
  razorpay_order_id text,
  razorpay_payment_id text,
  razorpay_signature text,
  amount_paise int default 1000,
  status text default 'paid',
  created_at timestamptz default now()
);

-- 4. trigger function to set registration_code automatically
create or replace function public.set_registration_code()
returns trigger as $$
begin
  if new.registration_code is null then
    new.registration_code := public.generate_seminar_code();
  end if;
  new.created_at := now();
  return new;
end;
$$ language plpgsql;

create trigger trg_set_registration_code
before insert on public.seminar_registrations
for each row execute function public.set_registration_code();
```

**Notes:**
- `amount_paise` default is 1000 (₹10). If you change the fee, either set `amount_paise` in the create-order call or update the default. 
- `event_slug` should uniquely identify your event instance (e.g., `friday-2025-10-03`).

---

## 3. Server endpoints — create-order & verify-payment (Node)

You will deploy two secure server endpoints to handle Razorpay & Supabase service-role operations. Example code below is designed for Vercel (`/api/*.js`) or Netlify Functions (adjust export style slightly).

### Environment variables (set on Vercel/Netlify dashboard)
- `RAZORPAY_KEY_ID` (Razorpay key id - test or live)
- `RAZORPAY_KEY_SECRET` (Razorpay secret)
- `SUPABASE_URL` (eg. https://xyz.supabase.co)
- `SUPABASE_SERVICE_ROLE_KEY` (Supabase service role key) — server-only

### `/api/create-order.js`

```js
// Create a Razorpay order and return order + key_id
import fetch from 'node-fetch';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method Not Allowed' });

  const { amount_paise = 1000, receipt = null } = req.body ?? {};
  const keyId = process.env.RAZORPAY_KEY_ID;
  const keySecret = process.env.RAZORPAY_KEY_SECRET;

  if (!keyId || !keySecret) return res.status(500).json({ error: 'Razorpay keys not configured' });

  const orderPayload = {
    amount: amount_paise,
    currency: 'INR',
    receipt: receipt || `sem-${Date.now()}`,
    payment_capture: 1
  };

  const basicAuth = Buffer.from(`${keyId}:${keySecret}`).toString('base64');

  try {
    const r = await fetch('https://api.razorpay.com/v1/orders', {
      method: 'POST',
      headers: {
        Authorization: `Basic ${basicAuth}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderPayload)
    });

    const data = await r.json();
    if (!r.ok) return res.status(500).json({ error: 'Razorpay order creation failed', details: data });

    return res.json({ order: data, key_id: keyId });
  } catch (err) {
    console.error(err);
    return res.status(500).json({ error: 'Internal error', details: err.message });
  }
}
```

### `/api/verify-payment.js`

```js
// Verify Razorpay payment and insert registration into Supabase
import crypto from 'crypto';
import fetch from 'node-fetch';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method Not Allowed' });

  const { razorpay_payment_id, razorpay_order_id, razorpay_signature, student } = req.body ?? {};

  if (!razorpay_payment_id || !razorpay_order_id || !razorpay_signature || !student) {
    return res.status(400).json({ error: 'Missing parameters' });
  }

  const keySecret = process.env.RAZORPAY_KEY_SECRET;
  if (!keySecret) return res.status(500).json({ error: 'Razorpay secret not configured' });

  const expected = crypto.createHmac('sha256', keySecret)
    .update(`${razorpay_order_id}|${razorpay_payment_id}`)
    .digest('hex');

  if (expected !== razorpay_signature) {
    return res.status(400).json({ error: 'Invalid signature — payment verification failed' });
  }

  // verify payment captured
  const keyId = process.env.RAZORPAY_KEY_ID;
  const basicAuth = Buffer.from(`${keyId}:${keySecret}`).toString('base64');

  const fetchRes = await fetch(`https://api.razorpay.com/v1/payments/${razorpay_payment_id}`, {
    headers: { Authorization: `Basic ${basicAuth}` }
  });
  const paymentInfo = await fetchRes.json();
  if (!fetchRes.ok || paymentInfo.status !== 'captured') {
    return res.status(400).json({ error: 'Payment not captured', details: paymentInfo });
  }

  // Insert into Supabase via REST using service_role key
  const SUPABASE_URL = process.env.SUPABASE_URL;
  const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;
  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
    return res.status(500).json({ error: 'Supabase not configured on server' });
  }

  const insertPayload = {
    event_slug: student.event_slug,
    student_name: student.name,
    student_email: student.email,
    student_phone: student.phone || null,
    college: student.college || null,
    year: student.year || null,
    razorpay_order_id,
    razorpay_payment_id,
    razorpay_signature,
    amount_paise: paymentInfo.amount || 1000,
    status: 'paid'
  };

  const supaRes = await fetch(`${SUPABASE_URL}/rest/v1/seminar_registrations`, {
    method: 'POST',
    headers: {
      apikey: SUPABASE_SERVICE_ROLE_KEY,
      Authorization: `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
      'Content-Type': 'application/json',
      Prefer: 'return=representation'
    },
    body: JSON.stringify(insertPayload)
  });

  const supaJson = await supaRes.json();
  if (!supaRes.ok) {
    console.error('Supabase insert failed', supaJson);
    return res.status(500).json({ error: 'DB insert failed', details: supaJson });
  }

  const inserted = Array.isArray(supaJson) ? supaJson[0] : supaJson;

  return res.json({ ok: true, registration_code: inserted.registration_code, id: inserted.id });
}
```

**Important:** The `verify-payment` endpoint must be server-side only and must not trust client-side confirmation. Deploy both endpoints to a secure serverless platform and store secrets as environment variables.

---

## 4. Supabase Edge Functions alternative (optional)

If you prefer to keep everything inside Supabase, you can implement both endpoints as Supabase Edge Functions. Benefits: secrets stored in Supabase, minimal infra. Approach:

- Edge function `/create-order` uses Razorpay keys (set as Supabase function secrets) to create an order and returns `order` and `key_id`.
- Edge function `/verify-payment` performs signature verification, calls the Razorpay payments API to double-check `captured`, then uses Supabase `service_role` key (available to edge function as secret) to insert into `seminar_registrations`.

Supabase Edge Functions use Deno/JS; code will be similar but use Supabase SDK and `fetch`.

---

## 5. Client integration (GitHub Pages) — modal + JS

Add the Razorpay script in your site `<head>`:

```html
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
```

### Minimal modal HTML (paste into your event page)

```html
<!-- Registration modal (hidden by default) -->
<div id="reg-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:18px; border-radius:8px; width:90%; max-width:480px;">
    <h3>Seminar Registration (₹10)</h3>
    <form id="reg-form">
      <input name="event_slug" type="hidden" value="friday-seminar" />
      <div><label>Name</label><input name="name" required /></div>
      <div><label>Email</label><input name="email" type="email" required /></div>
      <div><label>Phone</label><input name="phone" /></div>
      <div><label>College</label><input name="college" /></div>
      <div style="margin-top:8px;"><button type="submit">Pay ₹10 & Register</button> <button id="reg-cancel" type="button">Cancel</button></div>
    </form>
    <div id="reg-status" style="margin-top:8px;color:green;"></div>
  </div>
</div>
```

### Client JS (replace `API_BASE` with your deployed server base)

```html
<script type="module">
  const API_BASE = 'https://<your-deploy-host>/api'; // update

  function openRegModal(slug) {
    const modal = document.getElementById('reg-modal');
    modal.style.display = 'flex';
    document.querySelector('#reg-form [name="event_slug"]').value = slug;
  }

  document.getElementById('reg-cancel').addEventListener('click', () => {
    document.getElementById('reg-modal').style.display = 'none';
  });

  document.querySelectorAll('.btn-register-now').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const slug = btn.getAttribute('data-event-slug') || 'friday-seminar';
      openRegModal(slug);
    });
  });

  document.getElementById('reg-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const statusEl = document.getElementById('reg-status');
    statusEl.style.color = 'black';
    statusEl.textContent = 'Creating order...';

    const form = e.target;
    const student = {
      name: form.name.value.trim(),
      email: form.email.value.trim(),
      phone: form.phone.value.trim(),
      college: form.college.value.trim(),
      year: form.year?.value || null,
      event_slug: form.event_slug.value
    };

    const createResp = await fetch(`${API_BASE}/create-order`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount_paise: 1000, receipt: `sem-reg-${Date.now()}` })
    });

    if (!createResp.ok) {
      statusEl.style.color = 'red';
      statusEl.textContent = 'Failed to create order. Try again.';
      return;
    }

    const { order, key_id } = await createResp.json();
    statusEl.textContent = 'Opening payment window...';

    const options = {
      key: key_id,
      amount: order.amount,
      currency: order.currency,
      name: 'VIC Seminar',
      description: `Entry fee for ${student.event_slug}`,
      order_id: order.id,
      handler: async function (response) {
        statusEl.textContent = 'Verifying payment...';
        const verifyResp = await fetch(`${API_BASE}/verify-payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature,
            student
          })
        });

        if (!verifyResp.ok) {
          const errText = await verifyResp.text();
          statusEl.style.color = 'red';
          statusEl.textContent = 'Payment verification failed. Please contact us.';
          console.error('verify-payment error', errText);
          return;
        }

        const verifyJson = await verifyResp.json();
        statusEl.style.color = 'green';
        statusEl.textContent = `Payment successful! Your entry no: ${verifyJson.registration_code}`;
        setTimeout(() => document.getElementById('reg-modal').style.display = 'none', 3000);
      },
      modal: { ondismiss: function () { statusEl.style.color = 'red'; statusEl.textContent = 'Payment window closed. Registration cancelled.'; } },
      prefill: { name: student.name, email: student.email, contact: student.phone }
    };

    const rzp = new window.Razorpay(options);
    rzp.open();
  });
</script>
```

**How to wire buttons:** Add `class="btn-register-now"` and `data-event-slug="friday-2025-10-03"` to each event register button.

---

## 6. Environment variables and deployment instructions

### Vercel (recommended for simplicity)
1. Create a new project in Vercel and link to a GitHub repo with `/api/create-order.js` and `/api/verify-payment.js` in the `/api` folder. 
2. In Vercel dashboard → Settings → Environment Variables, add:
   - `RAZORPAY_KEY_ID` (preview: use Razorpay test key id)
   - `RAZORPAY_KEY_SECRET` (preview: test secret)
   - `SUPABASE_URL` (project URL)
   - `SUPABASE_SERVICE_ROLE_KEY` (service role key)
3. Deploy. After deployment your endpoints will be available at `https://<project>.vercel.app/api/create-order` and `/api/verify-payment`.
4. Update `API_BASE` in your GitHub Pages client JS to point at `https://<project>.vercel.app/api`.

### Netlify
- Place functions in `netlify/functions` folder, adapt exports to Netlify function format, and set env variables in Netlify site settings.

### Supabase Edge Functions
- Deploy Deno-based functions to Supabase. Use secrets in Supabase dashboard for Razorpay and use the `service_role` secret for DB inserts.

---

## 7. Testing checklist & Razorpay test cards

**Testing steps:**
1. Use Razorpay test keys in your server environment.
2. Deploy serverless endpoints.
3. Add client JS with `API_BASE` pointing to your deployed endpoints on GitHub Pages.
4. Open an event page, click Register, and complete payment using Razorpay test card details.
5. Verify Supabase table `seminar_registrations` has a new row with `registration_code`.
6. Confirm client receives the `registration_code` and shows it to the user.

**Razorpay test card** (common test card):
- Card: `4111 1111 1111 1111` — any valid future expiry (e.g., 12/30) — any CVV — test OTP `123456` if prompted. (Check Razorpay docs for other test cards and test UPI flows.)

**Simulate failure flows:**
- Cancel in checkout — ensure no DB insert and client shows cancellation message.
- Force invalid signature (temporary) — ensure server rejects and no DB insert.

---

## 8. Admin UI & access to registrations

**Quick options to view registrations:**
- Supabase Console → Table Editor → `seminar_registrations` (fastest for admins).

**Recommended admin UI features:**
- Protected admin page (hosted on Vercel/Netlify) that lists registrations grouped by `event_slug` and allows:
  - Search/filter by name, email, registration_code.
  - Export CSV for a given event (query supabase REST or Postgres and format CSV).
  - Copy registration codes and mark attendees as "checked-in" (add a boolean `checked_in` column if needed).
  - Generate temporary signed URLs for any uploaded proofs (if you later collect attachments).

**Sample CSV export SQL**
```sql
select registration_code, event_slug, student_name, student_email, student_phone, college, year, created_at
from public.seminar_registrations
where event_slug = 'friday-2025-10-03'
order by created_at desc;
```

---

## 9. Error handling, logs & audit

- Log server errors to a logging service (Sentry / Logflare / Vercel logs). Keep details minimal but include `razorpay_order_id` & `student_email` for tracing.
- On `verify-payment` failure, store the failure reason in an `audit_logs` table or push an alert to Slack.

**Example `audit_logs` table**
```sql
create table if not exists public.audit_logs (
  id bigint generated by default as identity primary key,
  event_slug text,
  action text,
  details jsonb,
  created_at timestamptz default now()
);
```

- Add an audit log entry on each successful registration insert and on each verification failure.

---

## 10. Security & compliance (Aadhaar / PII guidance)

- For this seminar feature you only collect non-sensitive PII (name, email, phone, college). These are still personal data and must be protected.
- **Do not** collect Aadhaar or any national ID on the registration form. If later you must verify identity, do it offline at the event or ask the student to upload a masked ID and store it in a private Supabase bucket with restricted admin access.
- Access to Supabase service_role key must be limited and rotated periodically. Keep it in serverless env vars only.
- Use HTTPS everywhere (GitHub Pages + Vercel both use TLS by default).
- Comply with any institutional privacy policy; add a short consent checkbox on the registration form: "I consent to VIC storing my information for registration and event communications." Link to Privacy Policy.

---

## 11. Payment edge cases: refunds, failed payments, retries

**Refunds:**
- Use Razorpay dashboard or API to process refunds. Maintain a `refunds` table if you want to track refunds related to `seminar_registrations`.

**Failed payments:**
- If payment not captured or Razorpay returns failure, do **not** create a DB row and inform the user. Log the attempted order id and details in `audit_logs`.

**Retries:**
- A failed checkout can be retried by creating a new order via `/api/create-order`. Avoid creating multiple DB rows for the same student for the same event — your admin UI or server can check for existing `student_email` + `event_slug` combos.

**Duplicate prevention:**
- Optionally add a unique constraint to avoid duplicates: e.g., `unique(student_email, event_slug)` — but warn users if you enforce it (some students may legitimately register multiple times).

---

## 12. Analytics, email receipts & export

**Analytics:**
- Track events: `register_click`, `order_created`, `payment_success`, `payment_failure` with Google Analytics or Plausible. This helps measure conversion rate.

**Email receipts:**
- After `verify-payment` and DB insert, optionally send an email receipt to the student (use SendGrid / Mailgun). Include `registration_code`, event info, date/time, and refund policy.

**Sample receipt content:**
```
Subject: VIC Seminar Registration Confirmed — {{registration_code}}
Hi {{student_name}},
Your registration for {{event_name}} is confirmed. Entry no: {{registration_code}}.
Date: {{event_date}}
Please bring your student ID on arrival.
Transaction ID: {{razorpay_payment_id}}

Thanks,
VIC Team
```

---

## 13. Appendix — sample cURL & debugging tips

**Test create-order via cURL**
```bash
curl -X POST https://<your-deploy>/api/create-order \
  -H 'Content-Type: application/json' \
  -d '{"amount_paise":1000, "receipt":"test-123"}'
```

**Test verify-payment via cURL (use values returned by test flow)**
```bash
curl -X POST https://<your-deploy>/api/verify-payment \
  -H 'Content-Type: application/json' \
  -d '{"razorpay_payment_id":"pay_XXX","razorpay_order_id":"order_YYY","razorpay_signature":"sig_ZZZ","student": {"name":"Test User","email":"t@example.com","event_slug":"friday-2025-10-03"}}'
```

**Debugging tips:**
- If `verify-payment` rejects signature: ensure you used *the same* `razorpay_order_id` and `razorpay_payment_id` received from Razorpay and that `RAZORPAY_KEY_SECRET` matches the key used to create the order.
- If `create-order` fails: check Razorpay dashboard for API keys and account limits; inspect response body for specific error code.
- Use server logs (Vercel logs) to inspect responses from Razorpay and Supabase.

---

## 14. Next steps I can implement for you
If you want, I can now produce one of the following and deliver it ready-to-deploy:
- A. A small GitHub repo with `/api/create-order.js` and `/api/verify-payment.js` plus a `README.md` and Vercel `vercel.json`. (You only add env vars and deploy.)
- B. Supabase Edge Functions code that does both endpoints (if you prefer to keep everything in Supabase).
- C. A polished modal UI (HTML + Tailwind classes) matching your VSIE theme and the exact script with `API_BASE` configured.
- D. An admin React page (hosted on Vercel) to view/export registrations and mark attendees checked-in.

Tell me which of A/B/C/D you want and I will generate the files ready to paste into your repo or deploy to Supabase.

---

*End of guide.*
